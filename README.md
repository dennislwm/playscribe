# playscribe

---
# 1. Introduction
## 1.1. Purpose

This document describes the `playscribe` automation and manual services that is provided for DevSecOps Engineer, Mac and Mobile Users.

## 1.2. Audience

The audience for this document includes:

* Mobile User who will add URLs, via Bookmark or Email, and consume RSS feeds on their iPhone device.

* Mac User who will add URLs, via Bookmark or Email, consume RSS feeds, and query text from an archive on their workstation.

* DevSecOps Engineer who will design system workflows, configure any SaaS or selfhosted services, and plan for disaster recovery.

---
# 2. System Overview
## 2.1. Benefits and Values

1. This system leverages on and applies a similar design from the [playboard](https://github.com/dennislwm/playboard) automation to its workflow.

2. The Mobile or Mac User will add a YouTube URL with tag `youtube` that is analogous to sending a message to a queue.

3. The messages are sent to an SaaS application (**Pinboard.in**), which manages the URLs and provides separate RSS feeds for different tags that can be consumed.

4. Currently there isn't an automated process to consume the RSS feed, process a URL and publish the result.

## 2.2. Workflow

This project uses several methods and products to optimize your workflow.
- Uses a SaaS application (**Pinboard.in**) to produce Bookmarks using a Bookmarklet or by sending an Email.
- Uses a SaaS application (**Pinboard.in**) to manage Bookmarks and share them as separate RSS feeds using Tags.
- Uses a MacOS/iOS application (**NetNewsWire**) to consume individual RSS feeds and save them to a cloud storage.
- Uses a Cloud Storage (**OneDrive.com**) to read, write and synchronise the RSS feeds.
- Uses a Continuous Integration pipeline (**GitHub Actions**) to consume an RSS feed, process a Bookmark and publish the result.

---
# 3. User Personas
## 3.1 RACI Matrix

| Category  |                       Activity                       | Mobile User | Mac User | DevSecOps |
|:---------:|:----------------------------------------------------:|:-----------:|:--------:|:---------:|
| Execution | Download an autogenerated subtitle file from YouTube |             |          |    R,A    |
| Execution |             Convert a `vtt` file to text             |             |          |    R,A    |

---
# 4. Requirements
## 4.1. Local workstation

* [yt-dlp](https://github.com/yt-dlp/yt-dlp)
* [Python 3](https://www.python.org)

---
# 5. Installation and Configuration

---
# 6. Execution
## 6.1. Download an autogenerated subtitle file from YouTube

1. Open a terminal and run the command `yt-dlp --version` to check if it is installed.

```sh
2023.10.1
```

2. Type the following command to download the autogenerated subtitle of a YouTube video. Replace the YOUTUBE_URL with any YouTube link, e.g. `https://www.youtube.com/watch?v=x3vnCKivCjs`.

```sh
yt-dlp --write-auto-sub --skip-download [YOUTUBE_URL]
```

You should see an output similar to below.

```sh
[youtube] Extracting URL: https://www.youtube.com/watch?v=x3vnCKivCjs
[youtube] x3vnCKivCjs: Downloading webpage
[youtube] x3vnCKivCjs: Downloading ios player API JSON
[youtube] x3vnCKivCjs: Downloading android player API JSON
[youtube] x3vnCKivCjs: Downloading m3u8 information
[info] x3vnCKivCjs: Downloading subtitles: en
[info] x3vnCKivCjs: Downloading 1 format(s): 22
[info] Writing video subtitles to: The Fastest Way to Lose Belly Fat [x3vnCKivCjs].en.vtt
[download] Destination: The Fastest Way to Lose Belly Fat [x3vnCKivCjs].en.vtt
[download] 100% of   85.84KiB in 00:00:00 at 879.88KiB/s
```

The subtitle file name is created using the video title and code, e.g. `The Fastest Way to Lose Belly Fat [x3vnCKivCjs].en.vtt`.

If you open the `vtt` file, you'll notice that it contains metatags that makes it hard to read. You'll have to convert this `vtt` file to a text file using a Python script.

## 6.2. Convert a `vtt` file to text

Fortunately, there is a [Python script](https://gist.github.com/glasslion/b2fcad16bc8a9630dbd7a945ab5ebf5e) that converts youtube subtitle file (`vtt`) to plain text. Credit to [glasslion](https://gist.github.com/glasslion) for making it open-source.

> Note: I have reproduced the script below to make it easy to follow.

1. Create a new file `vtt2text.py` and copy and paste the following content into it:

```py
"""
Convert YouTube subtitles(vtt) to human readable text.

Download only subtitles from YouTube with youtube-dl:
youtube-dl  --skip-download --convert-subs vtt <video_url>

Note that default subtitle format provided by YouTube is ass, which is hard
to process with simple regex. Luckily youtube-dl can convert ass to vtt, which
is easier to process.

To conver all vtt files inside a directory:
find . -name "*.vtt" -exec python vtt2text.py {} \;
"""

import sys
import re


def remove_tags(text):
    """
    Remove vtt markup tags
    """
    tags = [
        r'</c>',
        r'<c(\.color\w+)?>',
        r'<\d{2}:\d{2}:\d{2}\.\d{3}>',

    ]

    for pat in tags:
        text = re.sub(pat, '', text)

    # extract timestamp, only kep HH:MM
    text = re.sub(
        r'(\d{2}:\d{2}):\d{2}\.\d{3} --> .* align:start position:0%',
        r'\g<1>',
        text
    )

    text = re.sub(r'^\s+$', '', text, flags=re.MULTILINE)
    return text

def remove_header(lines):
    """
    Remove vtt file header
    """
    pos = -1
    for mark in ('##', 'Language: en',):
        if mark in lines:
            pos = lines.index(mark)
    lines = lines[pos+1:]
    return lines


def merge_duplicates(lines):
    """
    Remove duplicated subtitles. Duplacates are always adjacent.
    """
    last_timestamp = ''
    last_cap = ''
    for line in lines:
        if line == "":
            continue
        if re.match('^\d{2}:\d{2}$', line):
            if line != last_timestamp:
                yield line
                last_timestamp = line
        else:
            if line != last_cap:
                yield line
                last_cap = line


def merge_short_lines(lines):
    buffer = ''
    for line in lines:
        if line == "" or re.match('^\d{2}:\d{2}$', line):
            yield '\n' + line
            continue

        if len(line+buffer) < 80:
            buffer += ' ' + line
        else:
            yield buffer.strip()
            buffer = line
    yield buffer


def main():
    vtt_file_name = sys.argv[1]
    txt_name =  re.sub(r'.vtt$', '.txt', vtt_file_name)
    with open(vtt_file_name) as f:
        text = f.read()
    text = remove_tags(text)
    lines = text.splitlines()
    lines = remove_header(lines)
    lines = merge_duplicates(lines)
    lines = list(lines)
    lines = merge_short_lines(lines)
    lines = list(lines)

    with open(txt_name, 'w') as f:
        for line in lines:
            f.write(line)
            f.write("\n")



if __name__ == "__main__":
    main()
```

2. In your terminal, type the following command:

```sh
python vtt2text.py The\ Fastest\ Way\ to\ Lose\ Belly\ Fat\ \[x3vnCKivCjs\].en.vtt
```

3. If successful, you'll find a new `txt` file created, e.g. `The Fastest Way to Lose Belly Fat [x3vnCKivCjs].en.txt`, which has readable text but still contains a few metadata lines.

```txt
00:00
today I'm going to share with you the absolute fastest way to lose your belly
now you could have the best willpower the best discipline really want it
really bad and never really see any results because you're missing the
technique you're missing the strategy I'm the perfect example I took guitar
lessons for six years right as a teenager and I never really progressed
or never really went anywhere because the techniques that were taught to me
were just not that great great the same thing happened with tennis in college I
was never taught the right technique and so I would use force and I would keep
practicing but practice incorrectly never went anywhere and this really
applies with weight loss too because if you have the right way of doing
something you don't have to put so much effort into it so what I'm going to show
you is the fastest way to achieve your goal number one when you do the

00:01
ketogenic diet it's not differentiated what type of fats you should be eating
in other words keto is really about low carb you assume it's high fat but
there's certain ketogenic diets that are actually lowfat like Ideal Protein for
example and others are very high in fat but in this first tip we're going to
talk about the type of fats this is so so important because I've done a deep
...
```